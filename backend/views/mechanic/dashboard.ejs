<!-- Mechanic Dashboard Page -->
<div class="container-fluid py-4">
  <!-- Header -->
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">
          <i class="fas fa-tools text-primary me-2"></i>
          Mechanic Dashboard
        </h1>
        <form
          action="/mechanic/toggle-availability"
          method="POST"
          class="d-inline"
        >
        <button
        type="submit"
        id="availability-btn"
        class="btn btn-success"
      >
        <i class="fas fa-check-circle me-2"></i>
        Available for Jobs
      </button>

        </form>
      </div>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card stats-card bg-success-gradient text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h3 class="mb-0" id="today-earnings">$0.00</h3>
              <p class="mb-0 text-white">Today's Earnings</p>
            </div>
            <div class="stats-icon">
              <i class="fas fa-dollar-sign"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card stats-card bg-primary-gradient text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h3 class="mb-0" id="active-jobs">0</h3>
              <p class="mb-0 text-white">Active Jobs</p>
            </div>
            <div class="stats-icon">
              <i class="fas fa-tools"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card stats-card bg-info-gradient text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h3 class="mb-0" id="completed-jobs">0</h3>
              <p class="mb-0 text-white">Completed Jobs</p>
            </div>
            <div class="stats-icon">
              <i class="fas fa-check-circle"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card stats-card bg-warning-gradient text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h3 class="mb-0" id="total-earnings">$0.00</h3>
              <p class="mb-0 text-white">Total Earnings</p>
            </div>
            <div class="stats-icon">
              <i class="fas fa-money-bill-wave"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Row -->
  <div class="row">
    <!-- Left Column: Bookings -->
    <div class="col-md-8">
      <!-- Current Bookings Card -->
      <div class="card mb-4">
        <div
          class="card-header d-flex justify-content-between align-items-center bg-white"
        >
          <h5 class="mb-0">
            <i class="fas fa-clipboard-list text-primary me-2"></i>
            Current Bookings
          </h5>
          <a href="/mechanic/history" class="btn btn-sm btn-outline-primary"
            >View All</a
          >
        </div>
        <div class="card-body">
          <div id="current-bookings-empty" class="text-center py-5" style="display: none;">
            <img
              src="/images/empty-jobs.png"
              alt="No Active Jobs"
              class="img-fluid mb-3"
              style="max-width: 200px"
            />
            <h5>No active jobs found</h5>
            <p class="text-muted">
              You don't have any active jobs at the moment.
            </p>
          </div>
          <div class="table-responsive" id="current-bookings-table" style="display: none;">
            <table class="table table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>Date</th>
                  <th>Customer</th>
                  <th>Problem</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="current-bookings-tbody">
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Nearby Booking Requests Card -->
      <div class="card">
        <div class="card-header bg-white">
          <h5 class="mb-0">
            <i class="fas fa-bell text-primary me-2"></i>
            Nearby Booking Requests
          </h5>
        </div>
        <div class="card-body">
          <div id="nearby-bookings-empty" class="text-center py-4" style="display: none;">
            <img
              src="/images/empty-requests.png"
              alt="No Requests"
              class="img-fluid mb-3"
              style="max-width: 150px"
            />
            <h5>No nearby requests</h5>
            <p class="text-muted">
              There are no booking requests in your area at the moment.
            </p>
          </div>
          <div class="row" id="nearby-bookings-container">
          </div>
        </div>
        
      </div>
      <div class="card">
        <div class="card-header bg-white">
          <h5 class="mb-0">
            <i class="fas fa-bell text-primary me-2"></i>
            User Requested Booking Requests
          </h5>
        </div>
        <div class="card-body">
          <div id="user-requested-bookings-empty" class="text-center py-4" style="display: none;">
            <img
              src="/images/empty-requests.png"
              alt="No Requests"
              class="img-fluid mb-3"
              style="max-width: 150px"
            />
            <h5>No nearby requests by users for you</h5>
            <p class="text-muted">
              There are no booking requests , reuested by user at the moment.
            </p>
          </div>
          <div class="row" id="user-requested-bookings-container">
          </div>
        </div>
        
      </div>

    </div>

    <!-- Right Column: Profile, Stats & Location -->
    <div class="col-md-4">
      <!-- Performance Stats Card -->
      <div class="card mb-4">
        <div class="card-header bg-white">
          <h5 class="mb-0">
            <i class="fas fa-chart-pie text-primary me-2"></i>
            Performance Stats
          </h5>
        </div>
        <div class="card-body">
          <canvas id="bookingChart" height="250"></canvas>
        </div>
      </div>

      <!-- Your Profile Card -->
      <div class="card mb-4">
        <div class="card-header bg-white">
          <h5 class="mb-0">
            <i class="fas fa-user-cog text-primary me-2"></i>
            Your Profile
          </h5>
        </div>
        <div class="card-body">
          <div class="text-center mb-4">
            <div class="avatar-circle-large bg-primary text-white mx-auto mb-3" id="profile-avatar">
              A
            </div>
            <h5 id="profile-name">Mechanic Name</h5>
            <div class="d-flex justify-content-center">
              <span id="profile-rating">(0.0)</span>
            </div>
          </div>
          <div class="mb-3">
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted">Specialization</span>
              <span id="profile-specialization">Loading...</span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted">Experience</span>
              <span id="profile-experience">0 years</span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted">Hourly Rate</span>
              <span class="text-success fw-bold" id="profile-rate">$0.00</span>
            </div>
            <div class="d-flex justify-content-between">
              <span class="text-muted">Status</span>
              <span class="badge bg-success" id="profile-status">Available</span>
            </div>
          </div>
          <div class="d-grid">
            <a href="/mechanic/profile" class="btn btn-outline-primary">
              <i class="fas fa-edit me-2"></i> Edit Profile
            </a>
          </div>
        </div>
      </div>

      <!-- Your Location Card -->
      <div class="card">
        <div class="card-header bg-white">
          <h5 class="mb-0">
            <i class="fas fa-map-marker-alt text-primary me-2"></i>Your Location
          </h5>
        </div>
        <div class="card-body p-0">
          <div id="user-map" style="height: 300px"></div>
        </div>
      </div>
  </div>
</div>


<style>
  .bg-primary-gradient {
    background: linear-gradient(135deg, #4361ee 0%, #3a56d4 100%);
  }
  .bg-warning-gradient {
    background: linear-gradient(135deg, #f8961e 0%, #f3722c 100%);
  }
  .bg-info-gradient {
    background: linear-gradient(135deg, #4cc9f0 0%, #4895ef 100%);
  }
  .bg-success-gradient {
    background: linear-gradient(135deg, #38b000 0%, #008000 100%);
  }
  .stats-card {
    border-radius: 15px;
    border: none;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    overflow: hidden;
    transition: all 0.3s ease;
  }
  .stats-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
  }
  .stats-icon {
    font-size: 2.5rem;
    opacity: 0.8;
  }
  .avatar-circle {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
  }
  .avatar-circle-large {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    font-weight: bold;
  }
  .booking-request-card {
    border-radius: 10px;
    transition: all 0.3s ease;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }
  .booking-request-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
  }
</style>


<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css"
/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", async function () {
    try {
      // Fetch dashboard data
      const response = await fetch('/mechanic/api/dashboard');
      const data = await response.json();

      if (data.error) {
        console.error('Error loading dashboard:', data.error);
        return;
      }

      const { user, profile, bookings, stats, totalEarnings, todayEarnings, nearbyBookings, userRequestedJob } = data;

      // Update statistics
      document.getElementById('today-earnings').textContent = `$${todayEarnings.toFixed(2)}`;
      document.getElementById('active-jobs').textContent = stats.inProgress;
      document.getElementById('completed-jobs').textContent = stats.completed;
      document.getElementById('total-earnings').textContent = `$${totalEarnings.toFixed(2)}`;

      // Update availability button
      const availabilityBtn = document.getElementById('availability-btn');
      if (profile.availability) {
        availabilityBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i>Available for Jobs';
        availabilityBtn.className = 'btn btn-success';
      } else {
        availabilityBtn.innerHTML = '<i class="fas fa-times-circle me-2"></i>Unavailable';
        availabilityBtn.className = 'btn btn-secondary';
      }

      // Update profile info
      document.getElementById('profile-name').textContent = user.name;
      document.getElementById('profile-avatar').textContent = user.name.charAt(0).toUpperCase();
      document.getElementById('profile-specialization').textContent = profile.specialization?.join(', ') || 'Not specified';
      document.getElementById('profile-experience').textContent = `${profile.experience} years`;
      document.getElementById('profile-rate').textContent = `$${profile.hourlyRate}`;
      document.getElementById('profile-status').textContent = profile.availability ? 'Available' : 'Unavailable';
      document.getElementById('profile-status').className = `badge ${profile.availability ? 'bg-success' : 'bg-secondary'}`;

      // Update current bookings
      const currentBookingsTbody = document.getElementById('current-bookings-tbody');
      const currentBookingsEmpty = document.getElementById('current-bookings-empty');
      const currentBookingsTable = document.getElementById('current-bookings-table');

      if (bookings.length > 0) {
        currentBookingsEmpty.style.display = 'none';
        currentBookingsTable.style.display = 'block';

        bookings.forEach(booking => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${new Date(booking.createdAt).toLocaleDateString()}</td>
            <td>${booking.user.name}</td>
            <td>${booking.problemCategory}</td>
            <td><span class="badge bg-${getStatusColor(booking.status)}">${booking.status.charAt(0).toUpperCase() + booking.status.slice(1)}</span></td>
            <td><a href="/mechanic/booking/${booking._id}" class="btn btn-sm btn-outline-primary">View</a></td>
          `;
          currentBookingsTbody.appendChild(row);
        });
      } else {
        currentBookingsEmpty.style.display = 'block';
        currentBookingsTable.style.display = 'none';
      }

      // Update nearby bookings
      const nearbyContainer = document.getElementById('nearby-bookings-container');
      const nearbyEmpty = document.getElementById('nearby-bookings-empty');

      if (nearbyBookings.length > 0) {
        nearbyEmpty.style.display = 'none';
        nearbyBookings.forEach(booking => {
          const col = document.createElement('div');
          col.className = 'col-md-6 mb-3';
          col.innerHTML = `
            <div class="card booking-request-card">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <h6 class="card-title mb-1">${booking.problemCategory}</h6>
                  <small class="text-muted">${new Date(booking.createdAt).toLocaleDateString()}</small>
                </div>
                <p class="card-text small text-muted mb-2">${booking.description.substring(0, 100)}...</p>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="text-primary fw-bold">${booking.user.name}</span>
                  <a href="/mechanic/booking/${booking._id}" class="btn btn-sm btn-primary">Accept</a>
                </div>
              </div>
            </div>
          `;
          nearbyContainer.appendChild(col);
        });
      } else {
        nearbyEmpty.style.display = 'block';
      }

      // Update user requested bookings
      const userRequestedContainer = document.getElementById('user-requested-bookings-container');
      const userRequestedEmpty = document.getElementById('user-requested-bookings-empty');

      if (userRequestedJob.length > 0) {
        userRequestedEmpty.style.display = 'none';
        userRequestedJob.forEach(booking => {
          const col = document.createElement('div');
          col.className = 'col-md-6 mb-3';
          col.innerHTML = `
            <div class="card booking-request-card">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <h6 class="card-title mb-1">${booking.problemCategory}</h6>
                  <small class="text-muted">${new Date(booking.createdAt).toLocaleDateString()}</small>
                </div>
                <p class="card-text small text-muted mb-2">${booking.description.substring(0, 100)}...</p>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="text-primary fw-bold">${booking.user.name}</span>
                  <a href="/mechanic/booking/${booking._id}" class="btn btn-sm btn-primary">View</a>
                </div>
              </div>
            </div>
          `;
          userRequestedContainer.appendChild(col);
        });
      } else {
        userRequestedEmpty.style.display = 'block';
      }

      // Initialize chart
      const ctx = document.getElementById('bookingChart').getContext('2d');
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Pending', 'In Progress', 'Completed', 'Cancelled'],
          datasets: [{
            data: [stats.pending, stats.inProgress, stats.completed, stats.cancelled],
            backgroundColor: ['#ffc107', '#007bff', '#28a745', '#dc3545'],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });

      // Initialize map
      const map = L.map("user-map").setView([0, 0], 13);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      }).addTo(map);

      const lat = user?.location?.coordinates?.[1] || 0;
      const lng = user?.location?.coordinates?.[0] || 0;

      // Try to get user's current location
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          function (position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;

            map.setView([lat, lng], 15);

            // Add marker
            const marker = L.marker([lat, lng]).addTo(map);
            marker.bindPopup("Your current location").openPopup();
          },
          function (error) {
            console.error("Geolocation error:", error);
            if (lat !== 0 && lng !== 0) {
              map.setView([lat, lng], 15);
              const marker = L.marker([lat, lng]).addTo(map);
              marker.bindPopup("Your location").openPopup();
            }
          }
        );
      } else {
        if (lat !== 0 && lng !== 0) {
          map.setView([lat, lng], 15);
          const marker = L.marker([lat, lng]).addTo(map);
          marker.bindPopup("Your location").openPopup();
        }
      }

    } catch (error) {
      console.error('Error loading dashboard data:', error);
    }
  });

  function getStatusColor(status) {
    switch (status) {
      case 'pending': return 'warning';
      case 'accepted': return 'info';
      case 'in-progress': return 'primary';
      case 'completed': return 'success';
      case 'cancelled': return 'danger';
      default: return 'secondary';
    }
  }
</script>

